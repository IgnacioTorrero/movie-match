# MovieMatch API

Este proyecto es una aplicaci√≥n compuesta por microservicios en Node.js para la gesti√≥n de autenticaci√≥n, pel√≠culas, calificaciones y recomendaciones personalizadas, utilizando JWT para la autenticaci√≥n, Swagger UI para la documentaci√≥n, y Podman para el despliegue de los contenedores. La arquitectura est√° dise√±ada para ser escalable, desacoplada y profesional, ideal para entornos de producci√≥n modernos.

üåê Este README tambi√©n est√° disponible en [English](README.md)  
---

## üìñ M√≥dulo te√≥rico

### 1) Tecnolog√≠as utilizadas

- **Lenguaje principal:** TypeScript (Node.js)
- **Framework:** Express
- **Base de datos:** MySQL 8 (contenedorizado)
- **ORM:** Prisma ORM
- **Autenticaci√≥n y Seguridad:** JWT (firma HS256)
- **Documentaci√≥n:** Swagger UI (v√≠a OpenAPI 3.0)
- **Cache:** Redis (para optimizaci√≥n de b√∫squedas y recomendaciones)
- **Contenedores:** Podman + podman-compose
- **Frontend:** React + Vite (integrado en `auth-service` y `movie-service`)
- **Build Tool:** Vite + TypeScript + npm
- **Testing:** Jest + Supertest
- **CI/CD:** GitHub Actions (workflow en `.github/workflows/ci.yml`)

### 2) Patrones de dise√±o utilizados

- **Controller-Service-Repository (C-S-R):** organizaci√≥n modular en capas que separa las rutas, l√≥gica de negocio y acceso a datos (usando Prisma como DAO).
- **DTO (Data Transfer Object):** separaci√≥n l√≥gica entre los datos de entrada/salida y el modelo interno, aunque no est√°n estructurados como archivos DTO.
- **Middleware:** manejo de autenticaci√≥n, validaci√≥n y errores reutilizable en cada capa del flujo HTTP.
- **Factory (impl√≠cito):** se crean objetos de respuesta derivados de entidades Prisma en funciones reutilizables.
- **Singleton:** tanto Prisma Client como Redis Client son instancias √∫nicas reutilizadas en cada servicio.
- **Builder (parcial):** la generaci√≥n de tokens JWT se realiza con una API fluida que permite construir el token din√°micamente.

### 3) Arquitectura utilizada

- Arquitectura **basada en microservicios** comunicados v√≠a HTTP, con posibilidad futura de escalar con eventos (Kafka, RabbitMQ).
- **Capas bien definidas en cada servicio:**
   - `routes`: define los endpoints p√∫blicos.
   - `services`: contiene la l√≥gica de negocio.
   - `middlewares`: validaciones, autenticaci√≥n y control de errores.
   - `prisma`: modelo y acceso a datos.
   - `swagger`: documentaci√≥n OpenAPI 3.0 por servicio.
   - `test`: pruebas unitarias y de integraci√≥n.
   - `front-end`: cliente React/Vite (cuando aplica).

### 4) Resumen de endpoints

#### üõ°Ô∏è Autenticaci√≥n (`/api/auth`)
- `POST /register`: Registrar un nuevo usuario.
- `POST /login`: Iniciar sesi√≥n. Devuelve un token JWT.

#### üë§ Usuarios (`/api/users`)
- üîí Este prefijo est√° reservado para futuras extensiones relacionadas a perfil de usuario. Actualmente, no expone rutas activas.

#### üé¨ Pel√≠culas (`/api/movies`)
- `POST /`: Crear una nueva pel√≠cula (requiere JWT).
- `GET /`: Listar pel√≠culas del usuario autenticado con filtros y paginaci√≥n.
- `GET /:id`: Obtener detalles de una pel√≠cula espec√≠fica (si pertenece al usuario).
- `PUT /:id`: Actualizar una pel√≠cula (requiere validaci√≥n de pertenencia).
- `DELETE /:id`: Eliminar una pel√≠cula (si pertenece al usuario).

#### ‚≠ê Calificaciones (`/api/ratings`)
- `POST /rate`: Calificar o actualizar la calificaci√≥n de una pel√≠cula (requiere JWT).

#### ü§ñ Recomendaciones (`/api/recommendations`)
- `GET /`: Obtener recomendaciones personalizadas de pel√≠culas para el usuario autenticado.
- `DELETE /cache`: Limpiar manualmente la cach√© de recomendaciones del usuario actual.

üí° Todos los endpoints salvo `/auth/register` y `/auth/login` requieren autenticaci√≥n mediante un token JWT.

---

## üìù M√≥dulo pr√°ctico

### 5) ¬øC√≥mo montar la aplicaci√≥n desde cero?

**Tecnolog√≠as necesarias a instalar en el entorno:**

- [Node.js 18+](https://nodejs.org/) (recomendado: versi√≥n LTS para compatibilidad con dependencias)
- [npm 9+](https://www.npmjs.com/) (incluido con Node.js, para gestionar paquetes y scripts)
- [Podman](https://podman.io/) (alternativa moderna a Docker para contenerizaci√≥n)
- [podman-compose](https://github.com/containers/podman-compose) (para orquestar m√∫ltiples servicios de forma declarativa)
- [MySQL Workbench](https://dev.mysql.com/downloads/workbench/) (opcional, para inspeccionar y modificar la base de datos gr√°ficamente)
- [Visual Studio Code](https://code.visualstudio.com/) o equivalente como entorno de desarrollo.
- [Prisma CLI](https://www.prisma.io/docs/reference/api-reference/command-reference) *(opcional)* si deseas correr migraciones manuales.
- Conexi√≥n a internet para instalar las dependencias con `npm install` y construir el frontend con Vite.

---

**Pasos para montar y ejecutar el proyecto:**

1. Clonar el repositorio y abrir la carpeta `movie-match-api` en tu IDE.
2. Instalar dependencias de cada microservicio y frontend ejecutando `npm install` dentro de sus respectivas carpetas.
3. Asegurarte de tener las variables de entorno correctamente definidas en los archivos `.env` y `.env.prod`.
4. Compilar los frontends si est√°s en entorno de producci√≥n:
   ```bash
   ./build-front.ps1
   ```
5. Ejecutar los siguientes comandos desde la terminal en el directorio ra√≠z del proyecto:

```bash
podman machine init #Para iniciar el podman
podman machine start #Para activar el podman
podman-compose up #Para levantar el proyecto
podman-compose down #Para frenar el proyecto
podman-compose build #Para buildear el proyecto despu√©s de un cambio
```
El orden para levantar de cero ser√≠a:
1) podman machine init
2) podman machine start
2) podman-compose build
3) podman-compose up

### 6) ¬øC√≥mo visualizar y testear Swagger UI?

Cuando este corriendo el proyecto, utilizar los siguientes endpoints:
- auth: http://localhost:3001/api-docs/
- movie: http://localhost:3002/api-docs/
- rating: http://localhost:3003/api-docs/ 
- recommendation: http://localhost:3004/api-docs/

### 7) ¬øC√≥mo testear cada endpoint en Postman?

**Paso a paso:**

1. Enviar una solicitud `POST` a `/api/auth/login` con el correo y contrase√±a registrados:

```json
{
   "email": "usuario@mail.com",
   "password": "1234"
}
```
2. Copiar el valor devuelto en la propiedad token.

3. En Postman, ir a la pesta√±a Authorization, seleccionar Bearer Token y pegar el token copiado:
```json
Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6...
```
4. A partir de ah√≠, podr√°s probar cualquier endpoint protegido usando ese token en la cabecera de autorizaci√≥n.

Listado de endpoints con ejemplos para testear:

üõ°Ô∏è Autenticaci√≥n
```json
POST /api/auth/register
Body:
{
  "name": "Juan",
  "email": "juan@mail.com",
  "password": "1234"
}
```
```json
POST /api/auth/login
Body:
{
  "email": "juan@mail.com",
  "password": "1234"
}
```
üé¨ Pel√≠culas
```json
GET /api/movies
```
```json
POST /api/movies
Body:
{
  "title": "Matrix",
  "director": "Wachowski",
  "year": 1999,
  "genre": "Sci-Fi",
  "synopsis": "Neo descubre la verdad..."
}
```
```json
GET /api/movies/1
```
```json
PUT /api/movies/1
Body:
{
  "title": "Matrix Reloaded",
  "director": "Wachowski",
  "year": 2003,
  "genre": "Sci-Fi",
  "synopsis": "Segunda entrega de Matrix..."
}
```
```json
DELETE /api/movies/1
```
‚≠ê Calificaciones
```json
POST /api/ratings/rate
Body:
{
  "movieId": 1,
  "score": 4
}
```
ü§ñ Recomendaciones
```json
GET /api/recommendations
```
```json
DELETE /api/recommendations/cache
```
üí° Todos los endpoints, salvo /auth/register y /auth/login, requieren el token JWT en la cabecera Authorization.

### 8) üß™ Tests

Este proyecto incluye pruebas unitarias y de integraci√≥n utilizando **Jest** y **Supertest**, organizadas por microservicio. Cada test sigue buenas pr√°cticas: separaci√≥n de responsabilidades, mocks de dependencias, y validaci√≥n de l√≥gica de negocio.

#### üîç Alcance de las pruebas

- Se testean las rutas:
  - `auth.routes.ts`
  - `user.routes.ts`
  - `movie.routes.ts`
  - `rating.routes.ts`
  - `recommendation.routes.ts`

- Se testean los servicios:
  - `auth.service.ts`
  - `movie.service.ts`
  - `rating.service.ts`
  - `recommendation.service.ts`

- Se mockean dependencias como Prisma, Redis y JWT para aislar la l√≥gica.
- Se testean validaciones, respuestas esperadas, control de errores, flujos JWT y manejo de usuarios no autorizados.
- Se miden m√©tricas de cobertura por archivo con `--coverage`.

---

#### ‚ñ∂Ô∏è Comandos para ejecutar los tests (desde cada microservicio)

```bash
# Auth Service
npx jest src/test/routes/auth.routes.test.ts --coverage
npx jest src/test/routes/user.route.test.ts --coverage
npx jest src/test/services/auth.service.test.ts --coverage

# Movie Service
npx jest src/test/routes/movie.routes.test.ts --coverage
npx jest src/test/services/movie.service.test.ts --coverage

# Rating Service
npx jest src/test/routes/rating.routes.test.ts --coverage
npx jest src/test/services/rating.service.test.ts --coverage

# Recommendation Service
npx jest src/test/routes/recommendation.routes.test.ts --coverage
npx jest src/test/services/recommendation.service.test.ts --coverage
```
üí° Es recomendable correr los tests dentro de cada carpeta de microservicio (auth-service, movie-service, etc) para evitar errores de path o dependencias.

### 9) üîÑ CI/CD

Este proyecto integra **GitHub Actions** como herramienta de Integraci√≥n Continua (CI), con el objetivo de garantizar la calidad del c√≥digo, detectar errores autom√°ticamente y mantener los servicios funcionando correctamente en cada cambio enviado al repositorio.

---

### ‚úÖ Descripci√≥n del flujo CI

- **Disparador:** Ante cada `push` o `pull request` dirigido a la rama `main`.
- **Pasos principales del workflow:**
  - Instalar Node.js (versi√≥n 18 o superior).
  - Ejecutar `npm ci` para instalar dependencias de forma limpia.
  - Ejecutar los tests con **Jest** para cada microservicio.
  - Generar reportes de cobertura de c√≥digo (`--coverage`).
  - Verificar que el pipeline se complete exitosamente antes de permitir merges.

> üìÅ La definici√≥n completa del workflow se encuentra en `.github/workflows/ci.yml`.

---
## Extras y detalles t√©cnicos

- El token JWT tiene una duraci√≥n de **10 horas**.
- Todos los errores est√°n manejados mediante middlewares de error personalizados en cada microservicio.
- Swagger UI est√° configurado para mantener la autorizaci√≥n con JWT activa durante la sesi√≥n de testing.
- Se permite CORS desde cualquier origen (`*`) para facilitar pruebas desde frontend local o Postman.
- Redis cachea b√∫squedas filtradas y recomendaciones, optimizando el rendimiento.



Si algo no funciona, lo primero que deber√≠as revisar es:
- ‚ö° Que el contenedor de MySQL est√© corriendo correctamente y accesible desde los servicios.
- üîê Que el token JWT est√© presente y no haya expirado.
- ‚úâ Que los datos requeridos (como `email`, `password`, `title`, `score`, etc.) est√©n correctamente formateados en las requests.
- üß± Que los servicios frontales hayan sido correctamente construidos (`npm run build`) si est√°s usando el entorno productivo.

Cualquier duda extra, el c√≥digo est√° completamente modularizado, documentado y sigue convenciones profesionales en cada microservicio.

---

## üßë‚Äçüíª Contribuci√≥n y Licencia

Este proyecto fue desarrollado como un **challenge t√©cnico** y representa un ejemplo profesional de arquitectura basada en microservicios con Node.js, Express, Prisma, React y contenedores.

Si dese√°s sugerir mejoras, abrir un issue o enviar un pull request, ¬°bienvenido!

---

## üìÑ Licencia

Este proyecto se distribuye bajo la licencia **MIT**. Pod√©s utilizarlo, modificarlo y compartirlo libremente para fines personales o profesionales.

---